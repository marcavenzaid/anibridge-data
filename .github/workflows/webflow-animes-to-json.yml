name: Export Webflow Animes to JSON

on:
  workflow_dispatch:        # allow manual run
  schedule:
    - cron: "0 1 * * *"     # runs every day at 01:00 UTC

jobs:
  export-cms:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch CMS data from Webflow (Animes)
        run: |
          node -e "
          const fs = require('fs');

          (async () => {
            const url = \`https://api.webflow.com/v2/collections/67fffeccd6749ed6ce46961b/items\`;
            let items = [];
            let offset = 0;
            const limit = 100;

            while (true) {
              const res = await fetch(\`\${url}?offset=\${offset}&limit=\${limit}\`, {
                headers: {
                  'Authorization': 'Bearer ' + process.env.WEBFLOW_API_SITE_TOKEN,
                  'accept': 'application/json'
                }
              });
              const data = await res.json();
              if (!data.items || data.items.length === 0) break;
              items = items.concat(data.items);
              if (data.items.length < limit) break;
              offset += limit;
            }

            // Map only the fields we care about
            const simplified = items.map(i => ({
              name: i.fieldData.name,
              slug: i.fieldData.slug,
              thumbnail: i.fieldData['thumbnail'],
              releaseDate: i.fieldData['release-date'],
              genres: i.fieldData['genres'],
              description: i.fieldData['description'],
              youtubePlaylistId: i.fieldData['youtube-playlist-id'],
              trailerYoutubeVideoId: i.fieldData['trailer-youtube-video-id']
            }));

            fs.writeFileSync('animes.json', JSON.stringify(simplified, null, 2));
          })();
          "
        env:
          WEBFLOW_API_SITE_TOKEN: ${{ secrets.WEBFLOW_API_SITE_TOKEN }}

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add animes.json
          git commit -m "Auto-update animes.json from Webflow CMS" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  workflow-immortality:
    name: Keep workflow alive
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: ./.github/actions/workflow-immortality